<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <% const showSearch = false; %>
  <%- include('partials/nav', { user, showSearch }) %>

  <div class="container py-4">
    <h2 class="mb-4">Checkout</h2>

    <% if (messages && messages.error && messages.error.length) { %>
      <div class="alert alert-danger"><%= messages.error.join(', ') %></div>
    <% } %>
    <% if (messages && messages.success && messages.success.length) { %>
      <div class="alert alert-success"><%= messages.success.join(', ') %></div>
    <% } %>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card">
          <div class="card-header">Order Summary</div>
          <div class="card-body p-0">
            <% if (cartItems && cartItems.length) { %>
              <div class="list-group list-group-flush">
                <% cartItems.forEach(item => { %>
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold"><%= item.name %></div>
                      <small class="text-muted">Qty: <%= item.quantity %></small>
                    </div>
                    <div class="text-end">
                      <div>$<%= item.price.toFixed(2) %></div>
                      <small class="text-muted">Subtotal: $<%= item.subtotal.toFixed(2) %></small>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <div class="p-3 text-muted">Your cart is empty.</div>
            <% } %>
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span>$<%= subtotal.toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between text-muted">
              <span>GST (9%)</span>
              <% 
                const hasGst = (typeof gst !== 'undefined');
                const gstNum = hasGst ? Number(gst) : NaN;
                const gstValue = Number.isFinite(gstNum) ? gstNum : (Number(subtotal) * 0.09);
              %>
              <span>$<%= gstValue.toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Delivery Fee</span>
              <span><%= Number(shipping || 0) === 0 ? 'Free' : '$' + Number(shipping).toFixed(2) %></span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <% 
                const totalValue = (typeof total !== 'undefined' && total !== null)
                  ? Number(total)
                  : Number(subtotal) + Number(gstValue) + Number(shipping || 0);
              %>
              <span>$<%= totalValue.toFixed(2) %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card">
          <div class="card-header">Shipping Details</div>
          <div class="card-body">
            <form action="/checkout" method="post">
              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input name="fullName" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input name="email" type="email" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Payment Method</label>
                <select name="paymentMethod" class="form-select" required>
                  <option value="card">Credit / Debit Card</option>
                  <option value="cash">Cash on Delivery</option>
                  <option value="paynow">PayNow</option>
                  <option value="applepay">Apple Pay</option>
                </select>
              </div>
              <div class="mb-3" id="card-fields">
                <label class="form-label">Card Number</label>
                <input name="cardNumber" class="form-control" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456">
                <div class="row g-2 mt-2">
                  <div class="col-sm-6">
                    <label class="form-label">Expiry</label>
                    <input name="cardExpiry" class="form-control" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" aria-label="Card expiry (MM/YY)">
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label">CVV</label>
                    <input name="cardCvv" class="form-control" inputmode="numeric" autocomplete="cc-csc" placeholder="123" maxlength="4" aria-label="Card CVV">
                  </div>
                </div>
                <small class="text-muted d-block mt-2">Card details are required only for card payments.</small>
              </div>
              <button class="btn btn-success w-100" type="submit" <%= (cartItems && cartItems.length) ? '' : 'disabled' %>>
                Place Order
              </button>
            </form>
          </div>
        </div>
        <div class="mt-3">
          <a href="/cart" class="btn btn-lime btn-lg">Return to cart</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const paymentSelect = document.querySelector('select[name="paymentMethod"]');
      const cardFields = document.getElementById('card-fields');
      if (!paymentSelect || !cardFields) return;
      function toggleCardFields() {
        const isCard = paymentSelect.value === 'card';
        cardFields.style.display = isCard ? 'block' : 'none';
        cardFields.querySelectorAll('input').forEach(input => {
          input.required = isCard;
        });
      }
      paymentSelect.addEventListener('change', toggleCardFields);
      toggleCardFields();
    })();
  </script>
</body>
</html>
