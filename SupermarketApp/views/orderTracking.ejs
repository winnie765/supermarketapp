<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <title>Order Tracking</title>
  <style>
    .tracking-card {
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }
    .tracking-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      margin-top: 6px;
    }
  </style>
</head>
<body class="home-page">
  <% const showSearch = false; const showNavLinks = true; %>
  <%- include('partials/nav', { user, showSearch, showNavLinks }) %>

  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h2 class="mb-1">Track Order</h2>
        <p class="text-muted mb-0">Invoice <span class="fw-semibold"><%= order.invoiceNumber %></span></p>
      </div>
      <%
        const shippingRaw = order.shippingStatus || order.status || 'Processing';
        const shipping = String(shippingRaw || '').toLowerCase();
        const canCancel = !shipping.includes('deliver') && !shipping.includes('cancel');
      %>
      <div class="d-flex gap-2">
        <a class="btn btn-lime pill-shape" href="/orders">Back to orders</a>
        <a class="btn btn-dark-green pill-shape" href="/orders/<%= order.invoiceNumber %>">View invoice</a>
        <% if (canCancel) { %>
          <a href="/orders/<%= order.invoiceNumber %>/cancel" class="btn btn-danger pill-shape">Cancel</a>
        <% } %>
      </div>
    </div>

    <% if (messages && messages.error && messages.error.length) { %>
      <div class="alert alert-danger"><%= messages.error.join(', ') %></div>
    <% } %>
    <% if (messages && messages.success && messages.success.length) { %>
      <div class="alert alert-success"><%= messages.success.join(', ') %></div>
    <% } %>

    <div class="card tracking-card border-0 mb-4">
      <div class="card-body p-4">
        <div class="row g-4">
          <div class="col-lg-5">
            <h5 class="mb-3">Order Summary</h5>
            <div class="border rounded p-3 bg-white">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Placed on</span>
                <span><%= new Date(order.placedAt).toLocaleString() %></span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Payment</span>
                <span class="text-uppercase"><%= order.customer.paymentMethod %></span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Total</span>
                <span class="fw-semibold">$<%= Number(order.total || 0).toFixed(2) %></span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Status updated</span>
                <span><%= new Date(order.statusUpdatedAt || order.placedAt).toLocaleString() %></span>
              </div>
            </div>
          </div>
          <div class="col-lg-7">
            <% 
              const statusRaw = shippingRaw;
              const status = String(statusRaw || '').toLowerCase();
              const steps = [
                { key: 'placed', label: 'Order placed', hint: 'We received your order.' },
                { key: 'processing', label: 'Processing', hint: 'Picking and packing your items.' },
                { key: 'packed', label: 'Packed', hint: 'Order is ready for dispatch.' },
                { key: 'out_for_delivery', label: 'Out for delivery', hint: 'Driver is on the way.' },
                { key: 'delivered', label: 'Delivered', hint: 'Order delivered to your address.' }
              ];
              const isCancelled = status.includes('cancel');
              const statusToIndex = () => {
                if (status.includes('deliver')) return 4;
                if (status.includes('out for delivery') || status.includes('out')) return 3;
                if (status.includes('pack')) return 2;
                if (status.includes('process') || status.includes('paid') || status.includes('confirm')) return 1;
                if (status.includes('cancel')) return -1;
                return 1;
              };
              const currentIndex = statusToIndex();
              const progressPercent = currentIndex < 0 ? 0 : Math.round(((currentIndex + 1) / steps.length) * 100);
              const statusBadge = isCancelled ? 'bg-danger' : (currentIndex >= 4 ? 'bg-success' : 'bg-warning text-dark');
            %>

            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="mb-0">Tracking Status</h5>
              <span class="badge <%= statusBadge %> text-uppercase"><%= statusRaw %></span>
            </div>
            <div class="progress mb-4" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: <%= progressPercent %>%"></div>
            </div>
            <% if (isCancelled) { %>
              <div class="alert alert-danger mb-4">This order has been cancelled. If you need help, contact support.</div>
            <% } %>
            <ol class="list-unstyled d-grid gap-3 mb-0">
              <% steps.forEach((step, index) => { 
                const isDone = !isCancelled && currentIndex >= index;
                const isCurrent = !isCancelled && currentIndex === index;
                const dotClass = isDone ? 'bg-success' : 'bg-secondary';
                const labelClass = isCurrent ? 'text-success' : '';
              %>
                <li class="d-flex gap-3 align-items-start">
                  <span class="tracking-dot <%= dotClass %>"></span>
                  <div>
                    <div class="fw-semibold <%= labelClass %>"><%= step.label %></div>
                    <div class="text-muted small"><%= step.hint %></div>
                  </div>
                </li>
              <% }) %>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
