<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <title>Shop - Supermarket App</title>
</head>
<body class="home-page">
  <%- include('partials/nav', { user, showNavLinks: true }) %>

  <% const searchValue = typeof q === 'string' ? q : ''; %>
  <% const filterValue = typeof filter === 'string' ? filter : 'all'; %>
  <% 
    const categoryList = (typeof categories !== 'undefined' && Array.isArray(categories))
      ? categories
      : ['dairy','fruits','vegetables','bakery','beverages','snacks','meat','seafood','frozen','pantry'];
  %>
  <section id="catalog" class="container pb-5">
    <div class="shopping-search-section">
      <form action="/shopping" method="get" class="d-flex align-items-center shopping-search-form">
        <input type="search" name="q" class="form-control form-control-sm" placeholder="Search products" value="<%= searchValue %>">
        <select name="filter" class="form-select form-select-sm">
          <option value="all" <%= filterValue === 'all' ? 'selected' : '' %>>All categories</option>
          <% categoryList.filter(c => c && c !== 'all').forEach(cat => { %>
            <% const value = String(cat); %>
            <% const label = value.charAt(0).toUpperCase() + value.slice(1); %>
            <option value="<%= value %>" <%= filterValue === value ? 'selected' : '' %>><%= label %></option>
          <% }) %>
        </select>
        <button type="submit" class="btn btn-lime btn-sm">Filter</button>
      </form>
    </div>
    <div class="row g-4">
      <% products.forEach((product) => {
           const raw = (product.image || '').replace(/\\/g, '/').trim();
           const cleaned = raw.replace(/^public\//i, '').replace(/^\/?images\//i, '');
           const hasProtocol = /^https?:\/\//i.test(raw);
           const stockCount = Number.isFinite(Number(product.stock))
             ? Number(product.stock)
             : (Number.isFinite(Number(product.quantity)) ? Number(product.quantity) : 0);
           const isOutOfStock = stockCount <= 0;
           const stockLabel = isOutOfStock ? 'Out of stock' : `In stock: ${stockCount}`;

           // Ensure we always point to the public images directory unless an absolute URL is provided
           let imgSrc = '/images/ShoppingCart.png';
           if (raw) {
             imgSrc = hasProtocol ? raw : `/images/${cleaned || raw}`;
           }
      %>
        <div class="col-sm-6 col-lg-4">
          <div class="card h-100 shadow-sm border-0 product-card <%= isOutOfStock ? 'product-out-of-stock' : '' %>">
            <img src="<%= imgSrc %>" class="card-img-top product-thumb" alt="<%= product.name %>">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title"><%= product.name %></h5>
              <p class="card-text text-muted flex-grow-1"><%= product.description %></p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="stock-badge <%= isOutOfStock ? 'stock-out' : '' %>"><%= stockLabel %></span>
              </div>
              <form action="/add-to-cart/<%= product.id %>" method="post" class="mt-3">
                <div class="d-flex align-items-center justify-content-between gap-3">
                  <span class="fw-semibold text-success">$<%= Number(product.price).toFixed(2) %></span>
                  <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm qty-btn" data-step="-1" <%= isOutOfStock ? 'disabled' : '' %>>-</button>
                    <input
                      type="number"
                      name="quantity"
                      class="form-control form-control-sm text-center qty-input"
                      value="1"
                      min="1"
                      <%= stockCount > 0 ? `max=\"${stockCount}\"` : '' %>
                      <%= isOutOfStock ? 'disabled' : '' %>
                      style="width: 70px;"
                    >
                    <button type="button" class="btn btn-outline-secondary btn-sm qty-btn" data-step="1" <%= isOutOfStock ? 'disabled' : '' %>>+</button>
                  </div>
                  <button class="btn btn-lime <%= isOutOfStock ? 'btn-disabled' : '' %>" <%= isOutOfStock ? 'disabled' : '' %>>
                    <%= isOutOfStock ? 'Unavailable' : 'Add' %>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </section>
  <script>
    (function() {
      const forms = document.querySelectorAll('form[action^="/add-to-cart/"]');
      forms.forEach(form => {
        const input = form.querySelector('.qty-input');
        const buttons = form.querySelectorAll('.qty-btn');
        if (!input) return;
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const step = Number(btn.dataset.step) || 0;
            const min = Number(input.min) || 1;
            const max = Number.isFinite(Number(input.max)) ? Number(input.max) : null;
            let next = Number(input.value) || min;
            next += step;
            if (next < min) next = min;
            if (max !== null && next > max) next = max;
            input.value = next;
          });
        });
      });
    })();
  </script>
</body>
</html>
