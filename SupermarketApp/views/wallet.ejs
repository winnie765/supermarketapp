<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Wallet</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body class="home-page">
  <% const showSearch = false; %>
  <%- include('partials/nav', { user, showSearch }) %>

  <div class="container py-4">
    <div class="row justify-content-center g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
              <div>
                <h2 class="mb-1">Wallet</h2>
                <p class="text-muted mb-0">Top up your balance with a credit/debit card.</p>
              </div>
              <div class="text-end">
                <div class="text-muted small">Current balance</div>
                <div class="fs-4 fw-semibold">$<%= Number(balance || 0).toFixed(2) %></div>
              </div>
            </div>

            <% if (messages && messages.error && messages.error.length) { %>
              <div class="alert alert-danger"><% messages.error.forEach(function(msg){ %><div><%= msg %></div><% }); %></div>
            <% } %>
            <% if (messages && messages.success && messages.success.length) { %>
              <div class="alert alert-success"><% messages.success.forEach(function(msg){ %><div><%= msg %></div><% }); %></div>
            <% } %>

            <form action="/wallet/topup" method="post" class="row g-3">
              <div class="col-12">
                <label class="form-label">Top-up Amount (SGD)</label>
                <input type="number" name="amount" class="form-control" min="1" step="0.01" inputmode="decimal" placeholder="e.g. 20.00" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Cardholder Name</label>
                <input type="text" name="cardName" class="form-control" placeholder="Name on card" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Card Number</label>
                <input type="text" name="cardNumber" class="form-control" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Expiry (MM/YY)</label>
                <input type="text" name="cardExpiry" class="form-control" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">CVV</label>
                <input type="password" name="cardCvv" class="form-control" inputmode="numeric" autocomplete="cc-csc" placeholder="123" maxlength="3" required>
              </div>
              <div class="col-12 d-flex justify-content-between gap-2">
                <a href="/home" class="btn btn-lime flex-fill text-center">Back to Home</a>
                <button type="submit" class="btn btn-success flex-fill">Top Up Wallet</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const amountInput = document.querySelector('input[name="amount"]');
      if (!amountInput) return;
      amountInput.addEventListener('input', () => {
        const raw = amountInput.value;
        if (!raw || !raw.includes('.')) return;
        const parts = raw.split('.');
        if (parts[1] && parts[1].length > 2) {
          amountInput.value = `${parts[0]}.${parts[1].slice(0, 2)}`;
        }
      });

      const cardInput = document.querySelector('input[name="cardNumber"]');
      if (cardInput) {
        cardInput.addEventListener('input', () => {
          const digits = cardInput.value.replace(/\D/g, '').slice(0, 16);
          const groups = digits.match(/.{1,4}/g) || [];
          cardInput.value = groups.join(' ');
        });
      }

      const expiryInput = document.querySelector('input[name="cardExpiry"]');
      if (expiryInput) {
        expiryInput.addEventListener('input', () => {
          const digits = expiryInput.value.replace(/\D/g, '').slice(0, 4);
          const month = digits.slice(0, 2);
          const year = digits.slice(2, 4);
          expiryInput.value = year.length ? `${month}/${year}` : month;
        });
      }

      const cvvInput = document.querySelector('input[name="cardCvv"]');
      if (cvvInput) {
        cvvInput.addEventListener('input', () => {
          const digits = cvvInput.value.replace(/\D/g, '').slice(0, 3);
          cvvInput.value = digits;
        });
      }
    })();
  </script>
</body>
</html>
