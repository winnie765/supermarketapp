<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <% const hasPayPal = paypalClientId && paypalClientId.length; %>
  <% 
    const netsHasGst = (typeof gst !== 'undefined');
    const netsGstNum = netsHasGst ? Number(gst) : NaN;
    const netsSubtotal = Number(subtotal) || 0;
    const netsGst = Number.isFinite(netsGstNum) ? netsGstNum : (netsSubtotal * 0.09);
    const netsShipping = Number(shipping || 0) || 0;
    const netsTotal = (typeof total !== 'undefined' && total !== null)
      ? Number(total)
      : netsSubtotal + netsGst + netsShipping;
  %>
  <% const showSearch = false; %>
  <%- include('partials/nav', { user, showSearch }) %>

  <div class="container py-4">
    <h2 class="mb-4">Checkout</h2>

    <% if (messages && messages.error && messages.error.length) { %>
      <div class="alert alert-danger"><%= messages.error.join(', ') %></div>
    <% } %>
    <% if (messages && messages.success && messages.success.length) { %>
      <div class="alert alert-success"><%= messages.success.join(', ') %></div>
    <% } %>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card">
          <div class="card-header">Order Summary</div>
          <div class="card-body p-0">
            <% if (cartItems && cartItems.length) { %>
              <div class="list-group list-group-flush">
                <% cartItems.forEach(item => { %>
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold"><%= item.name %></div>
                      <small class="text-muted">Qty: <%= item.quantity %></small>
                    </div>
                    <div class="text-end">
                      <div>$<%= item.price.toFixed(2) %></div>
                      <small class="text-muted">Subtotal: $<%= item.subtotal.toFixed(2) %></small>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <div class="p-3 text-muted">Your cart is empty.</div>
            <% } %>
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span>$<%= subtotal.toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between text-muted">
              <span>GST (9%)</span>
              <% 
                const hasGst = (typeof gst !== 'undefined');
                const gstNum = hasGst ? Number(gst) : NaN;
                const gstValue = Number.isFinite(gstNum) ? gstNum : (Number(subtotal) * 0.09);
              %>
              <span>$<%= gstValue.toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Delivery Fee</span>
              <span><%= Number(shipping || 0) === 0 ? 'Free' : '$' + Number(shipping).toFixed(2) %></span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <% 
                const totalValue = (typeof total !== 'undefined' && total !== null)
                  ? Number(total)
                  : Number(subtotal) + Number(gstValue) + Number(shipping || 0);
              %>
              <span>$<%= totalValue.toFixed(2) %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card">
          <div class="card-header">Shipping Details</div>
          <div class="card-body">
            <form action="/checkout" method="post">
              <% if (savedCards && savedCards.length) { %>
                <div class="mb-3">
                  <label class="form-label">Saved card</label>
                  <select name="savedPaymentMethod" class="form-select" id="savedPaymentSelect">
                    <option value="">Use a new card</option>
                    <% savedCards.forEach(function(card) { %>
                      <option value="<%= card.id %>"><%= (card.label || card.brand || "Card") %> ending <%= card.last4 %></option>
                    <% }); %>
                  </select>
                </div>
              <% } %>
              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input name="fullName" class="form-control" value="<%= prefill && prefill.fullName ? prefill.fullName : '' %>" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input name="email" type="email" class="form-control" value="<%= prefill && prefill.email ? prefill.email : '' %>" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="3" required><%= prefill && prefill.address ? prefill.address : '' %></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Payment Method</label>
                <div class="d-flex flex-column gap-2">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="payCard" value="card" checked>
                    <label class="form-check-label" for="payCard">Credit / Debit Card</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="payNets" value="nets">
                    <label class="form-check-label" for="payNets">NETS QR</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="payCash" value="cash">
                    <label class="form-check-label" for="payCash">Cash on Delivery</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="payPaynow" value="paynow">
                    <label class="form-check-label" for="payPaynow">PayNow</label>
                  </div>
                  <% if (hasPayPal) { %>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="paymentMethod" id="payPaypal" value="paypal">
                      <label class="form-check-label" for="payPaypal">PayPal</label>
                    </div>
                  <% } %>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="payApple" value="applepay">
                    <label class="form-check-label" for="payApple">Apple Pay</label>
                  </div>
                </div>
              </div>
              <input type="hidden" name="cartTotal" id="cartTotal" value="<%= netsTotal.toFixed(2) %>">
              <div class="mb-3" id="card-fields">
                <label class="form-label">Card Number</label>
                <input name="cardNumber" id="cardNumber" class="form-control" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" maxlength="19">
                <div class="row g-2 mt-2">
                  <div class="col-12">
                    <label class="form-label">Name on Card</label>
                    <input name="cardName" class="form-control" autocomplete="cc-name" placeholder="Name as on card">
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label">Expiry</label>
                    <input name="cardExpiry" id="cardExpiry" class="form-control" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" aria-label="Card expiry (MM/YY)" maxlength="5" pattern="\d{2}/\d{2}">
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label">CVV</label>
                    <input name="cardCvv" id="cardCvv" class="form-control" inputmode="numeric" autocomplete="cc-csc" placeholder="123" maxlength="3" aria-label="Card CVV" pattern="\d{3}">
                  </div>
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" value="1" id="saveCard" name="saveCard">
                  <label class="form-check-label" for="saveCard">
                    Save this card for next time
                  </label>
                </div>
                <small class="text-muted d-block mt-2">Card details are required only for card payments.</small>
              </div>
              <button class="btn btn-success w-100" id="place-order-btn" type="submit" <%= (cartItems && cartItems.length) ? '' : 'disabled' %>>
                Place Order
              </button>
              <% if (hasPayPal) { %>
                <div id="paypal-section" class="mt-3" style="display: none;">
                  <div id="paypal-error" class="alert alert-danger d-none"></div>
                  <div id="paypal-button-container"></div>
                  <small class="text-muted d-block mt-2">PayPal will open a secure payment window to complete your order.</small>
                </div>
              <% } %>
            </form>
          </div>
        </div>
        <div class="mt-3">
          <a href="/cart" class="btn btn-lime btn-lg">Return to cart</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const paymentSelect = null; // replaced by radio group
      const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
      const cardFields = document.getElementById('card-fields');
      const checkoutForm = document.querySelector('form[action="/checkout"]');
      const savedSelect = document.getElementById('savedPaymentSelect');
      const cardNumber = document.getElementById('cardNumber');
      const cardExpiry = document.getElementById('cardExpiry');
      const cardCvv = document.getElementById('cardCvv');
      const placeOrderBtn = document.getElementById('place-order-btn');
      const paypalSection = document.getElementById('paypal-section');
      if (!cardFields) return;
      function toggleCardFields() {
        let method = 'card';
        paymentRadios.forEach(r => { if (r.checked) method = r.value; });
        const isCard = method === 'card';
        const usingSaved = savedSelect && savedSelect.value;
        const isPaypal = method === 'paypal';
        const isNets = method === 'nets';
        cardFields.style.display = isCard && !usingSaved ? 'block' : 'none';
        cardFields.querySelectorAll('input').forEach(input => {
          input.required = isCard && !usingSaved;
        });
        if (placeOrderBtn) {
          placeOrderBtn.style.display = isPaypal ? 'none' : 'block';
        }
        if (paypalSection) {
          paypalSection.style.display = isPaypal ? 'block' : 'none';
        }
        if (checkoutForm) {
          checkoutForm.action = isNets ? '/generateNETSQR' : '/checkout';
        }
      }
      paymentRadios.forEach(r => r.addEventListener('change', toggleCardFields));
      if (savedSelect) savedSelect.addEventListener('change', toggleCardFields);
      toggleCardFields();

      if (cardNumber) {
        const formatCard = (val) => {
          const cleaned = String(val || '').replace(/\D/g, '').slice(0, 16);
          return cleaned.replace(/(.{4})/g, '$1 ').trim();
        };
        cardNumber.addEventListener('input', () => {
          const before = cardNumber.value;
          const cursor = cardNumber.selectionStart || before.length;
          const digitsBeforeCursor = before.slice(0, cursor).replace(/\D/g, '').length;
          const formatted = formatCard(before);
          cardNumber.value = formatted;
          // position caret
          let pos = 0, digits = 0;
          while (pos < formatted.length && digits < digitsBeforeCursor) {
            if (/\d/.test(formatted[pos])) digits++;
            pos++;
          }
          cardNumber.selectionStart = cardNumber.selectionEnd = pos;
        });
      }
      if (cardExpiry) {
        cardExpiry.addEventListener('input', () => {
          const digits = cardExpiry.value.replace(/\D/g, '').slice(0, 4);
          let formatted = digits;
          if (digits.length > 2) {
            formatted = digits.slice(0, 2) + '/' + digits.slice(2);
          }
          cardExpiry.value = formatted;
        });
      }
      if (cardCvv) {
        cardCvv.addEventListener('input', () => {
          cardCvv.value = cardCvv.value.replace(/\D/g, '').slice(0, 3);
        });
      }
    })();
  </script>
  <% if (hasPayPal) { %>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>
    <script>
      (function() {
        const errorBox = document.getElementById('paypal-error');
        const buttonContainer = document.getElementById('paypal-button-container');
        if (!window.paypal || !buttonContainer) return;

        function showPayPalError(message) {
          if (!errorBox) return alert(message);
          errorBox.textContent = message;
          errorBox.classList.remove('d-none');
        }

        function clearPayPalError() {
          if (!errorBox) return;
          errorBox.textContent = '';
          errorBox.classList.add('d-none');
        }

        function getCheckoutPayload() {
          const fullName = document.querySelector('input[name="fullName"]')?.value || '';
          const email = document.querySelector('input[name="email"]')?.value || '';
          const address = document.querySelector('textarea[name="address"]')?.value || '';
          return { fullName, email, address };
        }

        paypal.Buttons({
          createOrder: () => {
            clearPayPalError();
            const payload = getCheckoutPayload();
            if (!payload.fullName || !payload.email || !payload.address) {
              showPayPalError('Please fill in your name, email, and address before paying with PayPal.');
              return Promise.reject(new Error('Missing checkout details'));
            }
            return fetch('/checkout/paypal/order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            })
              .then(res => res.json().then(data => ({ ok: res.ok, data })))
              .then(({ ok, data }) => {
                if (!ok || !data || !data.id) {
                  throw new Error((data && data.error) || 'Unable to start PayPal checkout.');
                }
                return data.id;
              })
              .catch(err => {
                showPayPalError(err.message || 'Unable to start PayPal checkout.');
                throw err;
              });
          },
          onApprove: (data) => {
            clearPayPalError();
            return fetch('/checkout/paypal/capture', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ orderId: data.orderID })
            })
              .then(res => res.json().then(body => ({ ok: res.ok, body })))
              .then(({ ok, body }) => {
                if (!ok || !body || !body.redirectUrl) {
                  throw new Error((body && body.error) || 'Unable to finalize PayPal payment.');
                }
                window.location.href = body.redirectUrl;
              })
              .catch(err => {
                showPayPalError(err.message || 'Unable to finalize PayPal payment.');
              });
          },
          onError: (err) => {
            console.error('PayPal checkout error:', err);
            showPayPalError('PayPal is unavailable right now. Please try again.');
          }
        }).render('#paypal-button-container');
      })();
    </script>
  <% } %>
</body>
</html>



